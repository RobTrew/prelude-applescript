{
  "title": "groupSortOn",
  "cells": [
    {
      "type": "code",
      "language": "applescript",
      "data": "-- Sort and group a list by comparing the results of a key function\n-- applied to each element. groupSortOn f is equivalent to\n-- groupBy eq $ sortBy (comparing f),\n-- but has the performance advantage of only evaluating f once for each\n-- element in the input list.\n-- This is a decorate-(group.sort)-undecorate pattern, as in the\n-- so-called 'Schwartzian transform'.\n-- Groups are arranged from from lowest to highest."
    },
    {
      "type": "code",
      "language": "applescript",
      "data": "-- groupSortOn :: Ord b => (a -> b) -> [a] -> [a]\n-- groupSortOn :: Ord b => [((a -> b), Bool)]  -> [a] -> [a]\non groupSortOn(f, xs)\n    script keyBool\n        on |λ|(a, x)\n            if class of x is boolean then\n                {asc:x, fbs:fbs of a}\n            else\n                {asc:true, fbs:({Tuple(x, asc of a)} & fbs of a)}\n            end if\n        end |λ|\n    end script\n    set {fs, bs} to {|1|, |2|} of unzip(fbs of foldl(keyBool, ¬\n        {asc:true, fbs:{}}, flatten({f})))\n    \n    set intKeys to length of fs\n    set ca to current application\n    script dec\n        property gs : map(my mReturn, fs)\n        on |λ|(x)\n            set nsDct to (ca's NSMutableDictionary's ¬\n                dictionaryWithDictionary:{val:x})\n            repeat with i from 1 to intKeys\n                (nsDct's setValue:((item i of gs)'s |λ|(x)) ¬\n                    forKey:(character id (96 + i)))\n            end repeat\n            nsDct as record\n        end |λ|\n    end script\n    \n    script descrip\n        on |λ|(bool, i)\n            ca's NSSortDescriptor's ¬\n                sortDescriptorWithKey:(character id (96 + i)) ¬\n                    ascending:bool\n        end |λ|\n    end script\n    \n    script grpUndec\n        on |λ|(grp)\n            script\n                on |λ|(x)\n                    val of x\n                end |λ|\n            end script\n            map(result, grp)\n        end |λ|\n    end script\n    \n    script aEq\n        on |λ|(p, q)\n            (a of p) = (a of q)\n        end |λ|\n    end script\n    \n    -- Sorted, grouped, undecorated\n    map(grpUndec, ¬\n        groupBy(aEq, ((ca's NSArray's arrayWithArray:map(dec, xs))'s ¬\n            sortedArrayUsingDescriptors:map(descrip, bs)) as list))\nend groupSortOn"
    }
  ]
}